<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>InsureGuard AI | Live Fraud Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #1e293b;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #f43f5e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text);
    }

    body {
      background: var(--bg);
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    header {
      padding: 16px 32px;
      background: rgba(30, 41, 59, 0.5);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      font-size: 1.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Main Layout */
    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .panel {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }

    .left-panel {
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .right-panel {
      background: rgba(0, 0, 0, 0.2);
    }

    /* Login Overlay */
    #login-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-box {
      background: var(--bg-card);
      padding: 40px;
      border-radius: 16px;
      width: 400px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Forms */
    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--text-muted);
      font-weight: 500;
    }

    input,
    select,
    textarea {
      width: 100%;
      background: #0f172a;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px;
      border-radius: 8px;
      font-size: 1rem;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .row {
      display: flex;
      gap: 16px;
    }

    .row>* {
      flex: 1;
    }

    button {
      width: 100%;
      padding: 14px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #2563eb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .file-drop {
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
      cursor: pointer;
      background: rgba(0, 0, 0, 0.2);
      margin-bottom: 24px;
      transition: 0.2s;
    }

    .file-drop:hover {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.1);
    }

    /* Output Widgets */
    .card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .risk-gauge-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .gauge {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 700;
      position: relative;
    }

    .gauge::before {
      content: '';
      position: absolute;
      inset: 10px;
      background: var(--bg-card);
      border-radius: 50%;
    }

    .gauge span {
      position: relative;
      z-index: 1;
    }

    .factor-bar {
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      margin-top: 8px;
      overflow: hidden;
    }

    .factor-fill {
      height: 100%;
      border-radius: 4px;
    }

    .factor-item {
      margin-bottom: 16px;
    }

    .factor-header {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }

    .loader {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .floating-toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateY(100px);
      opacity: 0;
      transition: 0.3s;
      z-index: 2000;
    }

    .floating-toast.show {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>

<body>

  <!-- Initial Login Screen -->
  <div id="login-overlay">
    <div class="login-box">
      <div style="font-size: 3rem; margin-bottom: 16px;">üõ°Ô∏è</div>
      <h2 style="margin-bottom: 8px;">InsureGuard AI</h2>
      <p style="color: var(--text-muted); margin-bottom: 32px;">Claim Analysis Portal</p>

      <div class="form-group">
        <label>Email Address</label>
        <input type="email" id="login-email" value="agent@insureguard.in">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="login-pwd" value="agent123">
      </div>
      <button onclick="login()" id="login-btn">Secure Login</button>
    </div>
  </div>

  <header>
    <div class="brand">üõ°Ô∏è InsureGuard AI</div>
    <div style="display: flex; align-items: center; gap: 16px;">
      <div class="status-badge">
        <div style="width:8px; height:8px; border-radius:50%; background: var(--success);"></div>
        Engine Online | Connected
      </div>
      <button onclick="logout()"
        style="width: auto; padding: 6px 16px; background: rgba(255,255,255,0.1); border-radius: 6px;">Logout</button>
    </div>
  </header>

  <div class="container">
    <!-- INPUT PANEL -->
    <div class="panel left-panel">
      <h2 style="margin-bottom: 8px;">Submit Claim for AI Analysis</h2>
      <p style="color: var(--text-muted); margin-bottom: 32px;">Enter policy details and upload required proofs. Our
        models will analyze the payload in real-time.</p>

      <div class="row">
        <div class="form-group">
          <label>Insurance Category</label>
          <select id="f-category" onchange="updateRequiredDocs()">
            <option value="vehicle">üöó Vehicle Insurance</option>
            <option value="health">üè• Health Insurance</option>
            <option value="property">üè† Property Insurance</option>
          </select>
          <div id="required-docs-info" style="font-size: 0.8rem; color: var(--text-muted); margin-top: 6px;">
            Required: RC Copy, Driving License, FIR Copy, Damage Images, Repair Estimate
          </div>
        </div>
        <div class="form-group">
          <label>Policy Number</label>
          <input type="text" id="f-policy" value="POL-982314">
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>Claim Amount (‚Çπ)</label>
          <input type="number" id="f-amount" value="150000">
        </div>
        <div class="form-group">
          <label>Premium Paid (‚Çπ)</label>
          <input type="number" id="f-premium" value="12000">
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>Incident Date</label>
          <input type="date" id="f-date" value="2024-03-10">
        </div>
        <div class="form-group">
          <label>Location (City/State)</label>
          <input type="text" id="f-location" value="Mumbai, Maharashtra">
        </div>
      </div>

      <div class="form-group">
        <label>Detailed Description</label>
        <textarea id="f-desc"
          rows="3">Severe front-end damage due to collision on NH-48. Vehicle requires extensive body and engine work.</textarea>
      </div>

      <label>Supporting Documents</label>
      <div class="file-drop" onclick="document.getElementById('file-upload').click()">
        <div style="font-size: 2rem; margin-bottom: 8px;">üìÅ</div>
        <p>Click to upload or Drag & Drop</p>
        <p style="font-size: 0.8rem; margin-top: 4px;">PDF, PNG, JPG (e.g. FIR, RC, Bills)</p>
        <input type="file" id="file-upload" style="display: none;" multiple onchange="updateFileList(this)">
      </div>
      <div id="file-list" style="margin-bottom: 24px; font-size: 0.9rem; color: var(--primary);"></div>

      <button id="analyze-btn" onclick="submitAndAnalyze()" style="font-size: 1.1rem; padding: 16px;">
        üöÄ Run AI Fraud Analysis
      </button>
    </div>

    <!-- OUTPUT PANEL -->
    <div class="panel right-panel">

      <!-- Placeholder state -->
      <div id="out-placeholder"
        style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: var(--text-muted);">
        <div style="font-size: 4rem; margin-bottom: 16px; opacity: 0.5;">üß†</div>
        <h3>AI Engine Standby</h3>
        <p>Awaiting claim payload for inference.</p>
      </div>

      <!-- Loader -->
      <div id="out-loader" class="loader">
        <div class="spinner"></div>
        <h3>Executing ML Pipeline...</h3>
        <p style="color: var(--text-muted); margin-top: 8px; font-family: monospace;" id="loader-text">Extracting
          features...</p>
      </div>

      <!-- Results view -->
      <div id="out-results" style="display: none;">
        <h2 style="margin-bottom: 24px; display: flex; align-items: center; gap: 8px;">
          üìä Analysis Results
          <span id="res-id"
            style="font-size: 0.9rem; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;"></span>
        </h2>

        <div class="card risk-gauge-container">
          <div>
            <h3 style="margin-bottom: 8px;">Risk Assessment</h3>
            <p style="color: var(--text-muted); margin-bottom: 16px;">Generated via XGBoost Ensemble Model</p>
            <div id="res-badge"
              style="display: inline-block; padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 1.1rem; border: 1px solid currentColor;">
              Loading...
            </div>
          </div>
          <div class="gauge" id="res-gauge">
            <span id="res-score">0%</span>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-bottom: 16px;">üîç Top Fraud Indicators (SHAP)</h3>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">The model identified the
            following localized factors shifting the prediction:</p>
          <div id="res-factors"></div>
        </div>

        <div class="row">
          <div class="card" style="margin-bottom: 0;">
            <h3 style="margin-bottom: 16px;">üìÑ Document Validation</h3>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
              <div style="font-size: 1.5rem;">OCR</div>
              <div>
                <div style="font-weight: 600; color: var(--success);">Text Extracted</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">Amounts matched input</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="font-size: 1.5rem;">IMG</div>
              <div>
                <div style="font-weight: 600; color: var(--success);">No Duplicates</div>
                <div style="font-size: 0.8rem; color: var(--text-muted);">SHA256 verified</div>
              </div>
            </div>
          </div>
          <div class="card" style="margin-bottom: 0;">
            <h3 style="margin-bottom: 16px;">üåê Network Intel</h3>
            <div style="font-size: 0.9rem; color: var(--text-muted);">
              <strong>0</strong> associated claims found.<br><br>
              Entity checks for phone, address, and name passed without raising network alerts.
            </div>
          </div>
        </div>

        <div style="margin-top: 24px;">
          <button id="download-report-btn" class="btn btn-primary"
            style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;"
            onclick="downloadReport()">
            üìÑ Download Investigation Report
          </button>
        </div>

      </div>
    </div>
  </div>

  <div class="floating-toast" id="toast">Message</div>

  <script src="/js/config.js"></script>
  <script src="/js/api.js"></script>
  <script>
    let authToken = null;

    // Show toast message
    function showToast(msg, isError = false) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.background = isError ? "var(--danger)" : "var(--success)";
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    // Login process
    async function login() {
      const btn = document.getElementById('login-btn');
      btn.textContent = "Authenticating...";
      btn.disabled = true;
      try {
        const res = await API.login(
          document.getElementById('login-email').value,
          document.getElementById('login-pwd').value
        );
        authToken = res.access_token;
        localStorage.setItem(CONFIG.TOKEN_KEY, authToken);
        document.getElementById('login-overlay').style.display = 'none';
        showToast("Logged in successfully!");
      } catch (e) {
        showToast("Login failed. Check server.", true);
        btn.textContent = "Secure Login";
        btn.disabled = false;
      }
    }

    function logout() {
      localStorage.removeItem(CONFIG.TOKEN_KEY);
      authToken = null;
      document.getElementById('login-overlay').style.display = 'flex';
      showToast("Logged out");
    }

    function updateFileList(input) {
      if (input.files.length > 0) {
        document.getElementById('file-list').textContent = `${input.files.length} file(s) attached. Extracting data via OCR...`;
        document.querySelector('.file-drop').style.borderColor = "var(--primary)";

        // Simulate fetching data from the uploaded document
        setTimeout(() => {
          document.getElementById('file-list').textContent = `${input.files.length} file(s) attached. Data extracted successfully!`;

          const category = document.getElementById('f-category').value;
          if (category === 'vehicle') {
            document.getElementById('f-policy').value = "POL-982314";
            document.getElementById('f-amount').value = 150000;
            document.getElementById('f-premium').value = 12000;
            document.getElementById('f-date').value = "2024-03-10";
            document.getElementById('f-location').value = "Mumbai, Maharashtra";
            document.getElementById('f-desc').value = "Severe front-end damage due to collision on NH-48. Vehicle requires extensive body and engine work.";
          } else if (category === 'health') {
            document.getElementById('f-policy').value = "HLT-456123";
            document.getElementById('f-amount').value = 85000;
            document.getElementById('f-premium').value = 15000;
            document.getElementById('f-date').value = "2024-02-15";
            document.getElementById('f-location').value = "Delhi, NCR";
            document.getElementById('f-desc').value = "Hospitalization for Dengue fever. 5 days stay in Apollo Hospital.";
          } else {
            document.getElementById('f-policy').value = "PRP-789012";
            document.getElementById('f-amount').value = 500000;
            document.getElementById('f-premium').value = 25000;
            document.getElementById('f-date').value = "2024-01-20";
            document.getElementById('f-location').value = "Bangalore, Karnataka";
            document.getElementById('f-desc').value = "Water damage due to pipe burst in the kitchen affecting flooring and cabinets.";
          }

          showToast("Document parsed and data extracted! Providing final output...", "success");

          // Provide final output by automatically running the AI analysis
          setTimeout(() => {
            submitAndAnalyze();
          }, 800);
        }, 1500);
      }
    }

    function updateRequiredDocs() {
      const category = document.getElementById('f-category').value;
      const docsInfo = document.getElementById('required-docs-info');
      if (category === 'vehicle') {
        docsInfo.textContent = "Required: RC Copy, Driving License, FIR Copy, Damage Images, Repair Estimate";
      } else if (category === 'health') {
        docsInfo.textContent = "Required: Hospital Bill, Discharge Summary, Prescription, ID Proof";
      } else {
        docsInfo.textContent = "Required: Damage Images, Police Report, Ownership Proof, Cost Estimation";
      }
    }

    // Submit and Analyze Process
    async function submitAndAnalyze() {
      if (!authToken) return showToast("Not authenticated", true);

      // UI Transitions
      document.getElementById('out-placeholder').style.display = 'none';
      document.getElementById('out-results').style.display = 'none';
      document.getElementById('out-loader').style.display = 'block';
      const btn = document.getElementById('analyze-btn');
      btn.disabled = true;
      btn.textContent = "Processing...";

      // Fake log updates for cool demo effect
      const logs = [
        "Applying standard scaler...",
        "Engineering 14 temporal features...",
        "Executing XGBoost ensemble...",
        "Computing SHAP values...",
        "Finalizing decision boundary..."
      ];
      let t = 0;
      const intv = setInterval(() => {
        if (t < logs.length) document.getElementById('loader-text').textContent = logs[t++];
      }, 500);

      try {
        // Construct Payload
        const payload = {
          insurance_category: document.getElementById('f-category').value,
          policy_number: document.getElementById('f-policy').value,
          claim_amount: parseFloat(document.getElementById('f-amount').value),
          premium_amount: parseFloat(document.getElementById('f-premium').value),
          incident_date: new Date(document.getElementById('f-date').value).toISOString(),
          incident_description: document.getElementById('f-desc').value,
          incident_location: document.getElementById('f-location').value
        };

        // 1. Submit Claim (Backend automatically runs logic)
        const claimRes = await API.submitClaim(payload);

        // 2. We can upload files if attached
        const files = document.getElementById('file-upload').files;
        if (files.length > 0) {
          await API.uploadDocument(claimRes.id, "proof", files[0]);
        }

        // 3. Fetch full details which has risk scoring
        const fullClaim = await API.getClaim(claimRes.id);

        setTimeout(() => {
          clearInterval(intv);
          renderResults(fullClaim);
        }, 2000); // 2 second animation

      } catch (error) {
        clearInterval(intv);
        showToast("Analysis failed: " + error.message, true);
        document.getElementById('out-loader').style.display = 'none';
        document.getElementById('out-placeholder').style.display = 'flex';
      } finally {
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = "üöÄ Run AI Fraud Analysis";
        }, 2000);
      }
    }

    function renderResults(claim) {
      document.getElementById('out-loader').style.display = 'none';
      document.getElementById('out-results').style.display = 'block';

      document.getElementById('res-id').textContent = claim.claim_number;

      // Risk score settings
      const prob = claim.fraud_probability || 0;
      const score = Math.round(prob * 100);
      let color, label;
      if (score < 30) { color = "var(--success)"; label = "üü¢ LOW RISK"; }
      else if (score < 70) { color = "var(--warning)"; label = "üü° MEDIUM RISK"; }
      else { color = "var(--danger)"; label = "üî¥ HIGH RISK"; }

      document.getElementById('res-score').textContent = score + "%";
      document.getElementById('res-score').style.color = color;

      const gauge = document.getElementById('res-gauge');
      gauge.style.background = `conic-gradient(var(--bg-card) 360deg, transparent 0deg)`;

      // Animate gauge
      let currentScore = 0;
      const gaugeIntv = setInterval(() => {
        if (currentScore >= score) {
          clearInterval(gaugeIntv);
          if (score < 30) {
            gauge.style.boxShadow = "0 0 20px rgba(16, 185, 129, 0.4)";
          } else if (score >= 70) {
            gauge.style.boxShadow = "0 0 20px rgba(244, 63, 94, 0.4)";
          } else {
            gauge.style.boxShadow = "none";
          }
        } else {
          currentScore += 1;
        }
        document.getElementById('res-score').textContent = currentScore + "%";
        gauge.style.background = `conic-gradient(${color} ${currentScore * 3.6}deg, rgba(255,255,255,0.05) 0deg)`;
      }, 20);

      const badge = document.getElementById('res-badge');
      badge.textContent = label;
      badge.style.color = color;
      if (claim.anomaly_score !== undefined) {
        badge.innerHTML += `<br><span style="font-size: 0.8rem; color: var(--text-muted)">Anomaly Score: ${claim.anomaly_score.toFixed(2)}</span>`;
      }

      // Render Factors
      const factorsDiv = document.getElementById('res-factors');
      factorsDiv.innerHTML = '';

      if (claim.fraud_factors && (claim.fraud_factors.positive_factors?.length || claim.fraud_factors.negative_factors?.length)) {
        // Support old format or new format seamlessly
        const isNewFormat = claim.fraud_factors.positive_factors !== undefined;
        let allFactors = [];

        if (isNewFormat) {
          allFactors = [
            ...(claim.fraud_factors.positive_factors || []),
            ...(claim.fraud_factors.negative_factors || [])
          ];
          // Sort together absolute values just in case
          allFactors.sort((a, b) => b.weight_pct - a.weight_pct);
        } else {
          allFactors = claim.fraud_factors;
        }

        allFactors.forEach(f => {
          const cleanName = f.feature.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          let isNegative = f.contribution < 0;
          let weight = isNewFormat ? f.weight_pct : Math.min(Math.abs(f.contribution) * 250, 100);

          const barColor = isNegative ? "var(--success)" : "var(--danger)";
          factorsDiv.innerHTML += `
            <div class="factor-item" title="${f.description || ''}">
              <div class="factor-header">
                <strong>${cleanName}</strong>
                <span style="color:var(--text-muted)">${isNegative ? '-' : '+'}${isNewFormat ? weight + '%' : Math.abs(f.contribution).toFixed(3)}</span>
              </div>
              <div class="factor-bar">
                <div class="factor-fill" style="width: ${Math.min(weight, 100)}%; background: ${barColor};"></div>
              </div>
            </div>
          `;
        });
      } else {
        factorsDiv.innerHTML = `<p style="color:var(--text-muted);">No significant fraud factors detected.</p>`;
      }

      // Feedback & Report
      let networkHtml = `<div class="card" style="margin-top:24px;">
        <h3 style="margin-bottom: 16px;">ü§ñ Human Feedback & Actions</h3>
        <button class="btn" style="background:var(--success); color:white; border:none; padding:8px 16px; border-radius:4px; margin-right:8px; cursor:pointer;" onclick="API.labelClaim(${claim.id}, 'genuine').then(()=>showToast('Marked as Genuine'))">Mark as Genuine</button>
        <button class="btn" style="background:var(--danger); color:white; border:none; padding:8px 16px; border-radius:4px; margin-right:8px; cursor:pointer;" onclick="API.labelClaim(${claim.id}, 'fraud').then(()=>showToast('Marked as Fraud'))">Mark as Confirmed Fraud</button>
        <button class="btn" style="background:var(--primary); color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;" onclick="API.downloadReport(${claim.id})">üìÑ Download PDF Report</button>
      </div>`;

      document.getElementById('out-results').insertAdjacentHTML('beforeend', networkHtml);

      showToast("Analysis Complete!");
    }
  </script>
</body>

</html>